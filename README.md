# FUREcast – SPLG Prediction & Analytics Platform

Hosted on Streamlit Cloud: https://splg-pulse.streamlit.app/
---

FUREcast is an educational analytics platform for the SPLG ETF combining a Gradient Boosting Regressor (GBR) prediction model, engineered technical features, automated nightly data updates, evaluation tooling, and agentic natural-language interaction. While suitable for academic exploration, outputs (including predictions) are not investment advice.

---

## 1. Core Objectives
- Predict next‑day SPLG percentage return (`target_return_t1`)
- Surface interpretable drivers via feature importance
- Provide exploratory visualizations of historical price, sector composition, and risk
- Enable natural-language querying over model outputs and data
- Maintain reproducibility with documented, automated retraining

---

## 2. High-Level Architecture

```
Data (SPLG OHLCV) → Feature Engineering → GBR Training → Artifacts (models/) 
        │                   │                    │
        └── Nightly Update Workflow (GitHub Action) ──> Streamlit App + Agent
```

Components:
- Streamlit application: [streamlit/production/app.py](streamlit/production/app.py)
- Prediction & feature extraction: [streamlit/production/pred_model/predict.py](streamlit/production/pred_model/predict.py), [streamlit/production/pred_model/get_latest_features.py](streamlit/production/pred_model/get_latest_features.py)
- Automated update & retrain pipeline: [streamlit/production/pred_model/update_and_retrain.py](streamlit/production/pred_model/update_and_retrain.py)
- Feature engineering: [streamlit/production/pred_model/build_splg_features.py](streamlit/production/pred_model/build_splg_features.py)
- Incremental feature rebuild: [streamlit/production/pred_model/feature_updater.py](streamlit/production/pred_model/feature_updater.py)
- Raw & engineered datasets: [data/SPLG_history_full.csv](data/SPLG_history_full.csv), [data/rich_features_SPLG_history_full.csv](data/rich_features_SPLG_history_full.csv)
- Model training & evaluation: [streamlit/production/pred_model/scripts/train_gbr_model.py](streamlit/production/pred_model/scripts/train_gbr_model.py), [streamlit/production/pred_model/scripts/evaluate_model.py](streamlit/production/pred_model/scripts/evaluate_model.py)
- Agentic interface (LLM orchestration): [streamlit/production/llm_interface.py](streamlit/production/llm_interface.py)
- Simulation & fallback logic: [`predict_splg`](streamlit/production/simulator.py)

---

## 3. Data Sources & Management

### 3.1 Primary Prediction Dataset
- File: [data/rich_features_SPLG_history_full.csv](data/rich_features_SPLG_history_full.csv)
- Range: 2006-09-01 → 2025-09-24 (≈19 years, 4,748 rows)
- Target variables:
  - `target_return_t1`: next-day percentage return (primary)
  - `target_close_t1`: next-day close (secondary / optional)
- Generated by feature pipeline: [`engineer_features`](streamlit/production/pred_model/build_splg_features.py)

### 3.2 Raw Historical Data
- File: [data/SPLG_history_full.csv](data/SPLG_history_full.csv)
- Source Acquisition: yfinance (via [`data_updater`](streamlit/production/pred_model/data_updater.py))
- Update Trigger: Nightly GitHub Action (workflow: [.github/workflows/daily-retrain.yml](.github/workflows/daily-retrain.yml))

### 3.3 Feature Engineering Overview
Feature categories (not exhaustive):
1. Price & Volume: OHLCV, spreads, normalizations
2. Price Relationships: ratios, differences (close/open, high/low)
3. Returns: rolling horizon simple & log returns (1d, 5d, 10d, 20d)
4. Trend / Moving Averages: multiple window MAs, slopes, ratios
5. Momentum: RSI, MACD components, ROC, raw momentum
6. Volatility: rolling std/var, ATR proxies, band widths
7. Volume Analytics: moving averages, volume ratios, OBV-like constructs
8. Lags: autoregressive lag features (1–10 day offsets, extended set)
9. Rolling Statistics: rolling min/max/skew/kurtosis windows
10. Calendar: day-of-week, month, quarter, year encodings

NaN Handling Strategies (in training script):
- Drop columns >95% NaN
- Forward-fill rolling window gaps (early periods)
- Replace infinities after division with safe values
- Preserve chronological order (no shuffling) to prevent look-ahead bias

### 3.4 Visualization Data
- Price history, engineered features, and simulated sector aggregates
- Sector holdings & mapping: [data/holdings-with-sectors.csv](data/holdings-with-sectors.csv), [data/treemap_nodes.csv](data/treemap_nodes.csv)
- Crisis timeline / events: [data/Financial Crisis Timeline by Day (since 2005).csv](data/Financial Crisis Timeline by Day (since 2005).csv)

### 3.5 Storage & Versioning
- Model artifacts: [streamlit/production/pred_model/models/](streamlit/production/pred_model/models/) (created post-training)
- Plots: [streamlit/production/pred_model/plots/](streamlit/production/pred_model/plots/)
- Logs: [streamlit/production/pred_model/logs/](streamlit/production/pred_model/logs/)
- Metadata: `model_metadata.json` (hyperparameters, data hash, timestamp)

---

## 4. Prediction Model (GBR)

### 4.1 Objective
Predict `target_return_t1` (next-day percentage return) using GradientBoostingRegressor with engineered technical, volatility, and calendar features.

### 4.2 Training Pipeline
Implemented in [`train_gbr_model.py`](streamlit/production/pred_model/scripts/train_gbr_model.py):
1. Load & validate dataset; parse dates
2. Split **_chronologically_**: 70% train / 15% validation / 15% test
3. NaN strategies (see Section 3.3)
4. Scale features (StandardScaler) – training fit only
5. Train GBR (quick mode defaults or grid search)
6. Persist artifacts (model, scaler, feature names, metrics, importance)

### 4.3 Default Hyperparameters (Quick Mode)
```
n_estimators: 300
learning_rate: 0.05
max_depth: 4
min_samples_split: 10
min_samples_leaf: 4
subsample: 0.8
max_features: "sqrt"
random_state: 42
```

### 4.4 Evaluation Metrics
Regression:
- MSE, RMSE, MAE, R², MAPE

Financial / Behavioral:
- Directional Accuracy (sign correctness)
- Sharpe Ratio
- Maximum Drawdown
- Profit Factor
- Win Rate

### 4.5 Visualizations (generated by [`main`](streamlit/production/pred_model/scripts/evaluate_model.py))
- Training progress (loss curve)
- Predictions vs actuals (train/val/test)
- Residuals scatter
- Feature importance (top N)
- Time-series predictions (test window)
- Cumulative returns (simple long/short strategy simulation)
- Error distributions

### 4.6 Inference
Functions: [`load_model`](streamlit/production/pred_model/predict.py), [`predict_with_explanation`](streamlit/production/pred_model/predict.py), [`get_latest_features`](streamlit/production/pred_model/get_latest_features.py)
- Aligns feature order exactly
- Applies stored scaler
- Determines direction: up / down / neutral
- Produces top feature importance slice

### 4.7 Failsafe & Fallback
If model artifacts are missing or load errors occur:
- [`predict_splg`](streamlit/production/simulator.py) falls back to LLM-generated simulated prediction
- Synthesizes plausible `predicted_return`, `direction`, confidence, and synthetic top features
- Ensures uninterrupted application operation

---

## 5. Automated Update & Nightly Retraining

Workflow Summary (triggered by GitHub Action [.github/workflows/daily-retrain.yml](.github/workflows/daily-retrain.yml)):
1. Fetch new SPLG data: [`check_for_updates`](streamlit/production/pred_model/data_updater.py)
2. Rebuild features incrementally or full: [`rebuild_features_from_scratch`](streamlit/production/pred_model/feature_updater.py)
3. Retrain (quick mode unless configured): [`main`](streamlit/production/pred_model/scripts/train_gbr_model.py)
4. Evaluate & update plots: [`main`](streamlit/production/pred_model/scripts/evaluate_model.py)
5. Log & append training history: [`log_training_results`](streamlit/production/pred_model/training_logger.py)

Manual orchestration:
```bash
cd streamlit/production/pred_model
python update_and_retrain.py --quick
```

---

## 6. Agentic Features (Natural Language Interface)

Module: [streamlit/production/llm_interface.py](streamlit/production/llm_interface.py)

Capabilities:
- Intent routing: [`route_query`](streamlit/production/llm_interface.py) (market_outlook, sector_analysis, feature_explanation, custom_visualization, general_question)
- Tool plan generation & response composition: [`compose_answer`](streamlit/production/llm_interface.py)
- Prediction explanation: [`explain_prediction`](streamlit/production/llm_interface.py)
- Access to:
  - Model predictions via [`predict_splg`](streamlit/production/simulator.py)
  - Historical prices via [`fetch_prices`](streamlit/production/simulator.py)
  - Risk metrics via [`compute_risk`](streamlit/production/simulator.py)
  - Visualization builders (e.g. sector treemaps, feature importance charts)

Underlying API: OpenAI (API key loaded from `.env` / secrets)

---

## 7. Application Hosting & Deployment

- Hosted on Streamlit Cloud: https://splg-pulse.streamlit.app/
- Entry point: [streamlit/production/app.py](streamlit/production/app.py)
- Modes:
  - Lite Mode: Core prediction + feature importance + charts
  - Pro Mode: Query interface (“Ask FUREcast”), expanded analytics panels
- Automatic detection of trained model vs fallback simulation

---

## 8. Repository Structure (Condensed)

```
/
├── README.md                  # (This file)
├── requirements.txt           # Global dependencies
├── data/                      # Raw & engineered SPLG datasets
├── wrangling/                 # Feature wrangling/engineering docs & notebooks
│   |── pred_model_feature_engineering/
│   |   └── README.md
│   └── sector_performance_treemap
│       └── SPLG_holdings_sector_fill
├── streamlit/
│   └── production/
│       ├── app.py
│       ├── simulator.py
│       ├── llm_interface.py
│       └── pred_model/
│           ├── update_and_retrain.py
│           ├── data_updater.py
│           ├── feature_updater.py
│           ├── scripts/
│           │   ├── train_gbr_model.py
│           │   └── evaluate_model.py
│           ├── predict.py
│           ├── get_latest_features.py
│           ├── models/ (generated during training)
│           ├── plots/  (generated during evaluation)
│           ├── logs/   (generated during training and evaluation)
├── .github/workflows/daily-retrain.yml
└── .env / .streamlit.secrets.toml
```

---

## 9. Setup & Installation

### 9.1 Prerequisites
- Python 3.11+
- (Recommended) Virtual environment (venv or conda)
- OpenAI API key (for agentic features & fallback)

### 9.2 Install Dependencies
```bash
python -m venv .venv
source .venv/bin/activate        # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```
Dependencies file: [requirements.txt](requirements.txt)

### 9.3 Environment Configuration
Create `.env`:
```
OPENAI_API_KEY=sk-...(can be provided upon request)
MARKETSENTIMENT_API_KEY = "d46lnphr01qgc9etei60d46lnphr01qgc9etei6g"
MARKET_AUX_API_KEY = "sfvJUu6JVVkhI6YucUlZeGTEwHkzic26DTwmnJ51"
FRED_KEY = "167c610d0808df0df6fc03d8a7c9f611"
```
Streamlit Cloud: use `.streamlit.secrets.toml` (not versioned with key content)

---

## 10. Running the Application

From repository root:
```bash
cd streamlit/production
streamlit run app.py
```

Optional flags (Streamlit standard) for headless/server deployment.

---

## 11. Training & Evaluation Workflows

### Quick Training & Complete Evaluation
```bash
cd streamlit/production/pred_model
python scripts/train_gbr_model.py --quick
python scripts/evaluate_model.py
```

### Full Tuned Training (updates optimal hyperparameters)
```bash
python scripts/train_gbr_model.py --tune
```

### Combined Training & Evaluation Script
```bash
./train_and_evaluate.sh
```
File: [streamlit/production/pred_model/train_and_evaluate.sh](streamlit/production/pred_model/train_and_evaluate.sh)

### Automated Nightly Data Update & Model Retraining
Workflow: [.github/workflows/daily-retrain.yml](.github/workflows/daily-retrain.yml) → [`update_and_retrain.py`](streamlit/production/pred_model/update_and_retrain.py)

---

## 12. Metrics & Interpretation

Stored in: `models/metrics.json` (post-training)
- Use charts in `plots/` for qualitative diagnostics
- Directional accuracy above random baseline (≈>52%) treated as a success threshold
- Low or negative R² common in noisy daily return prediction—emphasis on stability & calibration

Explanation:
- Feature importance from tree-based splits (`model.feature_importances_`)
- Natural language summarization via [`explain_prediction`](streamlit/production/llm_interface.py)

---

## 13. Fallback & Robustness

If model artifacts missing or invalid:
- [`predict_splg`](streamlit/production/simulator.py) synthesizes plausible prediction & feature set
- UI continues functioning (cards, charts, agent interface)
- Console/log prompts user to retrain (`train_gbr_model.py --quick`)

---

## 14. Logging & Monitoring

Locations:
- Training logs: [streamlit/production/pred_model/logs/](streamlit/production/pred_model/logs/)
- Evaluation logs: same directory (timestamped)
- Update flow logs aggregated by nightly automation
- History tracking: [training_history.jsonl](streamlit/production/pred_model/logs/training_history.jsonl)

---

## 15. Reproducibility & Versioning

Artifacts:
- `model_metadata.json`: hyperparameters, timestamp, feature count, data hash
- Chronological splits ensure consistency
- Random seed: 42 (model + NumPy)
- No data shuffling; all features derived from past-only windows

Documentation References:
- [wrangling/pred_model_feature_engineering/GBR_MODEL_TRAINING_GUIDE.md](wrangling/pred_model_feature_engineering/GBR_MODEL_TRAINING_GUIDE.md)
- [wrangling/pred_model_feature_engineering/QUICK_START_MODEL_TRAINING.md](wrangling/pred_model_feature_engineering/QUICK_START_MODEL_TRAINING.md)
- [streamlit/production/pred_model/IMPLEMENTATION_SUMMARY.md](streamlit/production/pred_model/IMPLEMENTATION_SUMMARY.md)

---

## 16. Security & Secrets

- API keys loaded via `.env` or Streamlit secrets
- No secrets committed to version control
- Defensive error handling around missing keys in:
  - [`get_openai_client`](streamlit/production/llm_interface.py)
  - Fallback simulation in [`predict_splg`](streamlit/production/simulator.py)

---

## 17. Roadmap (Potential Enhancements)

- Model ensembling (e.g., XGBoost / LightGBM comparison)
- Probabilistic calibration (quantile regression / conformal prediction)
- Extended sector / macro factor integration
- Live feature delta monitoring
- Adaptive retraining triggers (performance drift detection)

---

## 18. Support & Troubleshooting

Common Issues:
- Model not found → Retrain: `python scripts/train_gbr_model.py --quick`
- Low R² / accuracy → Consider tuning (`python scripts/train_gbr_model.py --tune`)
- Fallback triggered repeatedly → Check logs, confirm artifacts in `models/`

Reference Files:
- Training: [streamlit/production/pred_model/scripts/train_gbr_model.py](streamlit/production/pred_model/scripts/train_gbr_model.py)
- Evaluation: [streamlit/production/pred_model/scripts/evaluate_model.py](streamlit/production/pred_model/scripts/evaluate_model.py)
- Prediction: [streamlit/production/pred_model/predict.py](streamlit/production/pred_model/predict.py)

---

## 19. Academic Context

Extended methodological and feature documentation located in:
- [wrangling/pred_model_feature_engineering/README.md](wrangling/pred_model_feature_engineering/README.md)
- [wrangling/pred_model_feature_engineering/GBR_MODEL_TRAINING_GUIDE.md](wrangling/pred_model_feature_engineering/GBR_MODEL_TRAINING_GUIDE.md)
- Data dictionary (feature catalog) in `DATA_DICTIONARY.md` within same directory (not excerpted here).

---

## 20. License & Usage

Educational project—consult maintainers for usage clarification. Not financial advice.

---

## 21. Quick Start Summary

```bash
# 1. Clone & enter
git clone https://github.com/nthPerson/FEURCast.git
cd FEURCast

# 2. Environment
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# 3. (Optional) Train model
cd streamlit/production/pred_model
python scripts/train_gbr_model.py --quick
python scripts/evaluate_model.py

# 4. Run app
cd ../
streamlit run app.py
```

Fallback prediction may appear if step 3 is skipped.

---

For additional details, inspect:
- Execution flow: [`main`](streamlit/production/pred_model/update_and_retrain.py)
- Fallback logic: [`predict_splg`](streamlit/production/simulator.py)
- LLM orchestration: [`route_query`](streamlit/production/llm_interface.py), [`compose_answer`](streamlit/production/llm_interface.py)

---